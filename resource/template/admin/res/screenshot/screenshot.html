 <#include "admin/common/include/html_head.html"> <#include
"admin/common/include/sysparam.html"> <#include
"admin/common/include/pagination.html">

<!-- BEGIN FORM-->
 
	<div class="alert alert-error " id="screenshoterrTip" style="display: none;"></div> 
 
	<div class="portlet-body">
		<div class="clearfix">
			<button id="screenshot_add_btn" class="btn blue">
				<i class="icon-plus"></i>&nbsp;&nbsp;新增
			</button>
			<button id="screenshot_add_btn2" class="btn blue">
				<i class="icon-plus"></i>&nbsp;&nbsp;保存
			</button>
			<button id="screenshot_del_btn" class="btn blue">
				<i class="icon-trash"></i>&nbsp;&nbsp;删除
			</button>
		</div>
		<br> 
		<div id="screenshotShowDiv">
			<#include "admin/res/screenshotlist.html">
		</div> 
	</div>
 
<script>
var TableEditable = function () {

    return {

        //main function to initiate the module
        init: function (tableName) {
            function restoreRow(oTable, nRow) {
                var aData = oTable.fnGetData(nRow);
                var jqTds = $('>td', nRow);

                for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
                    oTable.fnUpdate(aData[i], nRow, i, false);
                }

                oTable.fnDraw();
            }
            var i = 0;
            var isEdit = false; 
            var nEditing = null;
            function editRow(oTable, nRow,isNew) {  
                var aData = oTable.fnGetData(nRow); 
                var jqTds = $('>td', nRow); 
                i++;
                jqTds[1].innerHTML = '<input type="text" require="true" datatype="require"   msg="标题不能为空" class="m-wrap small" value="' + aData[1] + '">';
                jqTds[2].innerHTML = '<input type="hidden" require="true" datatype="require"   msg="图片不能为空"  id=imgValue'+i+' class="m-wrap small" value="' + aData[2] + '"> <img id=img'+i+' width="80" height="80" id="imgShow2" /><button  class="btn"  onclick="common.showUploadPage(\'imgValue'+i+'\',\'img'+i+'\')" ><i class="icon-picture"></i>选择图片</button>';
                jqTds[3].innerHTML = '<input type="text" require="true" datatype="require"   msg="排位不能为空" class="m-wrap small" value="' + aData[3] + '">';
                jqTds[4].innerHTML = '<select class="m-wrap small" require="true" datatype="require"   msg="有效不能为空"> <option value=""></option> <option value="0">无效</option> <option value="1">有效</option></select>';
                jqTds[5].innerHTML = '<a class="edit" href="">保存</a>';
                if(isNew)
               	 	 jqTds[6].innerHTML = '<a class="delete" href="">删除</a>';
                else
                	 jqTds[6].innerHTML = '<a class="cancel" href="">取消</a>';
                isEdit = true; 
            }

            function saveRow(oTable, nRow) {
            	var valResult = AI.Validator.validForm('screenshowForm', 1, "screenshoterrTip"); 
    			if (!valResult)
    				return;
                var jqInputs = $('input', nRow);
                var jqSelects = $('select', nRow); 
                oTable.fnUpdate(jqInputs[0].value, nRow, 1, false);
                oTable.fnUpdate(jqInputs[1].value, nRow, 2, false);
                oTable.fnUpdate(jqInputs[2].value, nRow, 3, false);
                oTable.fnUpdate($(jqSelects[0]).find("option:selected").text(), nRow, 4, false);
                oTable.fnUpdate('<a class="edit" href="">编辑</a>', nRow, 5, false);
                oTable.fnUpdate('<a class="delete" href="">删除</a>', nRow, 6, false);
                oTable.fnDraw();
                isEdit = false;
            }

            function cancelEditRow(oTable, nRow) {
            	var jqSelects = $('select', nRow); 
                var jqInputs = $('input', nRow);
                oTable.fnUpdate(jqInputs[0].value, nRow, 1, false);
                oTable.fnUpdate(jqInputs[1].value, nRow, 2, false);
                oTable.fnUpdate(jqInputs[2].value, nRow, 3, false);
                oTable.fnUpdate($(jqSelects[0]).find("option:selected").text(), nRow, 4, false);
                oTable.fnUpdate('<a class="edit" href="">编辑</a>', nRow, 5, false);
                oTable.fnDraw();
            }

             $('#screenshot_add_btn2').click(function (e) { 
                e.preventDefault(); 
                if(isEdit){
                	common.alert({
    					content : '请先保存所有项目！'
    				});
    				return;
                } 
                var dataFieldDeinfe =new Array();
                var rows = $('#'+tableName).find("tr").length; 
                var dataDefine = 'id,name,imageUrl,rank,iseff';
                var dataDefineArr = dataDefine.split(",");
                var dataList; 
                $("#"+tableName+" tr:gt(0)").each(function(){ 
                	   var nRow = $(this);
                	   var nColLength = nRow.find("td").length-2; 
                	   var rowData=""; 
                	   var index=0;
                	   $(this).find("td:lt("+nColLength+")").each(function(){
                		   var nCol = $(this);  
                		   var nColValue = nCol.html()?"'"+nCol.html()+"'":null;
                		   var nColName = dataDefineArr[index]; 
                		   if(nColName == 'iseff'){ 
                			   if(nColValue ='有效'){
                				   nColValue=1;
                			   }else if(nColValue ='无效'){
                				   nColValue=0;
                			   }
                		   }
                		   rowData += "'"+nColName+"':"+nColValue +","; 
                		   index++;
                	   }); 
                	   if(rowData!=""){
	                	   rowData = "{"+rowData.substring(0,rowData.length-1)+"}"; 
	                	   if(!dataList)
	                	     dataList = rowData;  
	                	   else
	                		 dataList += ","+rowData ;
                		}
                });  
                dataList = "["+dataList+"]";  
                var param = "screenList="+dataList;
                    param +="&resouceId=1";
                console.log(param);
            	ajax.syncJsonRequest({
    				url : '${contextPath}/Admin-ResScreenShot-saveScreenshotList.action',
    				param : param,
    				success : function(data) {
    					if (!data || !data.success) {
    						$('#errtip').html('保存失败！');
    						$('#errtip').show();
    					}
    					if (data.success) { 
    						common.alert({
    							content : '保存成功！',
    							closeFn : function() { 
    								 mainFrame.addArea('${contextPath}/Admin-ResScreenShot-show.action?_QUERY_n_eq_resource_id=1','screenshotShowDiv'); 
    								 TableEditable.init("screenshotTable"); 
    							}
    						});
    					}
    				}
    			}); 
 		   });  
        
            var oTable = $('#'+tableName).dataTable({
                "aLengthMenu": [
                    [5, 15, 20, -1],
                    [5, 15, 20, "All"] // change per page values here
                ],
                // set the initial value
                "iDisplayLength": 5,
                "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
                "sPaginationType": "bootstrap",
                "oLanguage": {
                    "sLengthMenu": "_MENU_ 记录/每页",
                    "oPaginate": {
                        "sPrevious": "上一页",
                        "sNext": "下一页"
                    }
                },
                "aoColumnDefs": [{
                        'bSortable': false,
                        'aTargets': [0]
                    }
                ]
            });
 		    

            $('#screenshot_add_btn').click(function (e) {  
                e.preventDefault();
                var aiNew = oTable.fnAddData(['', '', '','','',
                        '<a class="edit" href="">编辑</a>', '<a class="delete" data-mode="new" href="">删除</a>'
                ]);   
                var nRow = oTable.fnGetNodes(aiNew[0]);  
                editRow(oTable, nRow, true);   
                nEditing = nRow;
            });

            $('#'+tableName+' a.delete').live('click', function (e) {
                e.preventDefault();
                var nRow = $(this).parents('tr')[0];
                if(nEditing=nRow && isEdit){
                	isEdit = false;
                }
                common.alert({
    				content : '是否删除选中项？',
    				showAction : true,
    				actionContent : '删除',
    				actionFn : function() { 
    		                oTable.fnDeleteRow(nRow);
    				}
    			});
                 
            });

            $('#'+tableName+' a.cancel').live('click', function (e) {
                e.preventDefault();
                var nRow = $(this).parents('tr')[0];
                nEditing = nRow;
                if ($(this).attr("data-mode") == "new") {  
                    oTable.fnDeleteRow(nRow);
                } else {  
                    restoreRow(oTable, nEditing);
                    nEditing = null;
                }
            });

            $('#'+tableName+' a.edit').live('click', function (e) {
                e.preventDefault();
				
                /* Get the row as a parent of the link that was clicked on */
                var nRow = $(this).parents('tr')[0];
                if ( this.innerHTML == "编辑") { 
                	nEditing = nRow;
                    /* Currently editing - but not this row - restore the old before continuing to edit mode */
                    restoreRow(oTable, nEditing); 
                    editRow(oTable, nRow); 
                    nEditing = nRow;
                } else if ( this.innerHTML == "保存") { 
                    /* Editing this row and want to save it */
                    nEditing = nRow;
                    saveRow(oTable, nEditing);
                    nEditing = null;
                    //alert("Updated! Do not forget to do some ajax to sync with backend :)");
                } else {
                    /* No edit in progress - let's start one */ 
                    editRow(oTable, nRow);
                    nEditing = nRow;
                }
            });
         $("#"+tableName+"_length").hide();
         $("#"+tableName+"_filter").hide();
         $("#"+tableName+"_info").hide();
        }

    };

}();
	jQuery(document).ready(function() { 
		  tableAction.init({
			tableId : 'screenshotTable',
			queryUrl : '${contextPath}/Admin-ResScreenShot-show.action?_QUERY_n_eq_resource_id=1',
			deleteUrl : '${contextPath}/Admin-ResScreenShot-delete.action',
			editUrl : '${contextPath}/Admin-ResScreenShot-showEditForm.action', 
			deleteBtnId : 'screenshot_del_btn' 
		});  
	 
		 mainFrame.addArea('${contextPath}/Admin-ResScreenShot-show.action?_QUERY_n_eq_resource_id=1','screenshotShowDiv'); 
		 TableEditable.init("screenshotTable"); 
	});
	
</script>
 